<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warehouse Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
  <style>
    #map { height: 600px; width: 100%; }
    #filters { margin: 20px; font-family: Arial, sans-serif; }
    #resetButton { padding: 6px 12px; margin-left:10px; }
    .legend {
      background:white; padding:8px; font-size:12px;
      line-height:1.4; border-radius:4px; border:1px solid #ccc;
    }

    .legend span {
      display:inline-block; width:12px; height:12px;
      margin-right:4px; vertical-align:middle;
    }

    #searchContainer {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }

    #searchInput {
      width: 200px;
      padding: 4px;
    }

    .ui-autocomplete {
      z-index: 2000 !important;
    }

    #heatmapToggleContainer {
      position: absolute;
      top: 100px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="filters">
    <label>Warehouse Type: <select id="warehouseTypeFilter"></select></label>
    <label>Supervisor: <select id="supervisorFilter"></select></label>
    <label>Region: <select id="regionFilter"></select></label>
    <button id="resetButton">Reset View</button>
  </div>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search Destination..." />
  </div>
  <div id="heatmapToggleContainer">
    <label><input type="checkbox" id="toggleHeatmap" /> Show Heatmap</label>
  </div>
  <div id="map"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?gid=542207452&single=true&output=csv';
    const cebuCoords = [10.3802, 123.9961];

    const cebuIcon = L.icon({
      iconUrl: 'https://www.gtcosmetics.com.ph/wp-content/uploads/2020/10/GT-Cosmetics.png',
      iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]
    });

    const map = L.map('map').setView([10.3157,123.8854], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const regionBounds = {
      "all": [[4.5,116],[20.5,127]], 
      "Region I": [[15.6,119.5],[18.7,121.5]], "CAR": [[16,120.5],[18,122]], "Region II": [[16.2,121.3],[18.5,122.5]], 
      "Region III": [[14.5,119.5],[16.2,121.5]], "NCR": [[14.3,120.8],[14.8,121.2]], "Region IV-A": [[13.4,120.5],[15,122]],
      "Region IV-B": [[11.8,118],[13.8,121.5]], "Region V": [[12.5,123.2],[14,124.5]], "Region VI": [[10.3,121],[11.8,123]],
      "Region VII": [[9.2,122.2],[11.5,124]], "Region VIII": [[10.5,124.5],[12.5,126]], "Region IX": [[6,121],[8.5,123]],
      "Region X": [[7.5,123.5],[9.5,125]], "Region XI": [[6.5,125],[8,126.5]], "Region XII": [[6,124],[7.8,126]],
      "Region XIII": [[8.5,125],[10.5,126.5]], "BARMM": [[5.5,120],[7.8,124.5]]
    };

    let allData = [], lines = [], markers = [], heatPoints = [];
    let currentSearchMarker = null;
    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    const heatLayer = L.heatLayer([], {
      radius: 25,
      blur: 20,
      maxZoom: 10,
      gradient: { 0.4: 'blue', 0.6: 'lime', 0.9: 'red' }
    });

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: res => {
        allData = res.data.filter(r => r['Route ID']);
        setup();
      }
    });

    function setup() {
      populateFilters();
      updateMap();
      addLegend();
      setupAutocomplete();

      document.getElementById('resetButton').addEventListener('click', resetMap);

      document.getElementById('toggleHeatmap').addEventListener('change', function () {
        if (this.checked) {
          heatLayer.setLatLngs(heatPoints);
          map.addLayer(heatLayer);
        } else {
          map.removeLayer(heatLayer);
        }
      });
    }

    function resetMap() {
      document.getElementById('warehouseTypeFilter').value = 'all';
      document.getElementById('supervisorFilter').value = 'all';
      document.getElementById('regionFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      if (currentSearchMarker) {
        map.removeLayer(currentSearchMarker);
        currentSearchMarker = null;
      }
      updateMap();
    }

    function populateFilters(){
      const warehouseTypeSet = new Set(), supervisorSet = new Set(), regionSet = new Set();
      allData.forEach(d => {
        warehouseTypeSet.add(d['Warehouse Type']);
        supervisorSet.add(d['Supervisor']);
        regionSet.add(d['Regional Destination']);
      });
      fillSelect('warehouseTypeFilter', warehouseTypeSet);
      fillSelect('supervisorFilter', supervisorSet);
      fillSelect('regionFilter', regionSet);
    }

    function fillSelect(id, set){
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="all">All</option>';
      Array.from(set).sort().forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
      sel.addEventListener('change', updateMap);
    }

    function updateMap(){
      lines.forEach(l=>map.removeLayer(l)); lines=[];
      markers.forEach(m=>map.removeLayer(m)); markers=[];
      markerCluster.clearLayers();
      heatPoints = [];

      const wf = document.getElementById('warehouseTypeFilter').value;
      const sf = document.getElementById('supervisorFilter').value;
      const rf = document.getElementById('regionFilter').value;

      const filt = allData.filter(d =>
        (wf==='all'||d['Warehouse Type']===wf)&&
        (sf==='all'||d['Supervisor']===sf)&&
        (rf==='all'||d['Regional Destination']===rf)
      );

      const gtMarker = L.marker(cebuCoords, {icon: cebuIcon})
        .bindTooltip('<b>GTCosmetics Manufacturing Inc.</b><br>Main Plant<br>Tayud, Liloan, Cebu', {
          permanent: false,
          direction:'top'
        });
      map.addLayer(gtMarker);
      markers.push(gtMarker);

      filt.forEach(draw);

      if (document.getElementById('toggleHeatmap').checked) {
        heatLayer.setLatLngs(heatPoints);
        map.addLayer(heatLayer);
      }

      if (rf !== 'all' && regionBounds[rf]) {
        map.fitBounds(regionBounds[rf]);
      } else if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([10.3157,123.8854], 6);
      }
    }

    function draw(d){
      if (!d['Origin Lat'] || !d['Origin Long'] || !d['Destination Lat'] || !d['Destination Long']) return;

      const o=[+d['Origin Lat'], +d['Origin Long']];
      const u=[+d['Destination Lat'], +d['Destination Long']];
      const latLngs = [o, u];

      lines.push(L.polyline(latLngs, {color: 'blue', weight: 2}).addTo(map));

      const m = L.marker(u, {
        icon: L.divIcon({
          className: 'destination-icon',
          html: `<div class="circle">${d['Route ID']}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).bindPopup(`<b>Route ID: ${d['Route ID']}</b><br><b>Warehouse Type:</b> ${d['Warehouse Type']}<br><b>Supervisor:</b> ${d['Supervisor']}<br><b>Destination:</b> ${d['Destination Name']}<br><b>Region:</b> ${d['Regional Destination']}`);

      markers.push(m);
      markerCluster.addLayer(m);

      heatPoints.push(o); // Add origin for heatmap
      heatPoints.push(u); // Add destination for heatmap
    }

    function setupAutocomplete(){
      const destinations = Array.from(new Set(allData.map(d => d['Destination Name'])));
      $("#searchInput").autocomplete({
        source: destinations,
        select: function(event, ui) {
          const destination = ui.item.value;
          const foundMarker = markers.find(m => m.getPopup().getContent().includes(destination));
          if (foundMarker) {
            map.setView(foundMarker.getLatLng(), 12);
            foundMarker.openPopup();
          }
        }
      });
    }

    function addLegend() {
      const legend = L.control({position: 'topright'});
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <b>Heatmap Legend</b><br>
          <span style="background:blue"></span> Low<br>
          <span style="background:lime"></span> Medium<br>
          <span style="background:red"></span> High
        `;
        return div;
      };
      legend.addTo(map);
    }
  </script>
</body>
</html>
