<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warehouse Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    #map { height: 600px; width: 100%; }
    #filters { margin: 20px; font-family: Arial, sans-serif; }
    select, button { padding: 6px; margin-right: 10px; }
    .legend { background: white; padding: 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; }
    .legend span { display: inline-block; width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }
    #spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; display: none; }
  </style>
</head>
<body>
  <div id="filters">
    <label>Warehouse Type: <select id="warehouseTypeFilter"></select></label>
    <label>Supervisor: <select id="supervisorFilter"></select></label>
    <label>Region: <select id="regionFilter"></select></label>
    <button id="resetButton">Reset View</button>
  </div>
  <div id="spinner">Loading...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?gid=542207452&single=true&output=csv';

    const map = L.map('map').setView([12.8797, 121.7740], 6);
    const cebuIcon = L.icon({
      iconUrl: 'https://www.gtcosmetics.com.ph/wp-content/uploads/2020/10/GT-Cosmetics.png',
      iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
    });

    let allData = [], lines = [], markers = [];

    const regionBounds = {
      'NCR': [[14.4, 120.9], [14.8, 121.2]],
      'Region I (Ilocos)': [[15.5, 119.5], [18.5, 120.8]],
      'Region II (Cagayan Valley)': [[16.0, 121.2], [18.0, 122.5]],
      'Region III (Central Luzon)': [[14.5, 119.5], [16.5, 121.5]],
      'Region IV-A (CALABARZON)': [[13.0, 120.5], [14.5, 122.0]],
      'Region IV-B (MIMAROPA)': [[9.5, 118.5], [13.5, 122.0]],
      'Region V (Bicol)': [[12.0, 123.0], [14.0, 124.3]],
      'Region VI (Western Visayas)': [[10.0, 121.0], [12.5, 123.0]],
      'Region VII (Central Visayas)': [[9.0, 122.0], [11.5, 124.0]],
      'Region VIII (Eastern Visayas)': [[10.0, 124.0], [12.5, 126.0]],
      'Region IX (Zamboanga Peninsula)': [[6.5, 121.0], [8.5, 123.5]],
      'Region X (Northern Mindanao)': [[7.5, 123.5], [9.5, 125.5]],
      'Region XI (Davao Region)': [[6.5, 125.0], [8.0, 126.5]],
      'Region XII (SOCCSKSARGEN)': [[5.8, 124.0], [7.5, 125.5]],
      'Region XIII (Caraga)': [[8.0, 125.0], [10.0, 127.0]],
      'CAR (Cordillera Administrative Region)': [[16.2, 120.0], [17.5, 121.2]],
      'BARMM': [[4.5, 119.5], [7.0, 122.0]]
    };

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function showSpinner(show) {
      document.getElementById('spinner').style.display = show ? 'block' : 'none';
    }

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: result => {
        allData = result.data.filter(r => r['Route ID']);
        setup();
      }
    });

    function setup() {
      populateFilters();
      updateMap();
      addLegend();
    }

    function populateFilters() {
      const wTypes = new Set(), supervisors = new Set(), regions = new Set();
      allData.forEach(d => {
        if (d['Warehouse Type']) wTypes.add(d['Warehouse Type']);
        if (d['Supervisor']) supervisors.add(d['Supervisor']);
        if (d['Regional Destination']) regions.add(d['Regional Destination']);
      });

      const warehouseFilter = document.getElementById('warehouseTypeFilter');
      const supervisorFilter = document.getElementById('supervisorFilter');
      const regionFilter = document.getElementById('regionFilter');

      warehouseFilter.innerHTML = '<option value="all">All</option>' +
        Array.from(wTypes).map(w => `<option>${w}</option>`).join('');
      supervisorFilter.innerHTML = '<option value="all">All</option>' +
        Array.from(supervisors).map(s => `<option>${s}</option>`).join('');
      regionFilter.innerHTML = '<option value="all">All</option>' +
        Array.from(regions).map(r => `<option>${r}</option>`).join('');

      warehouseFilter.onchange = supervisorFilter.onchange = regionFilter.onchange = updateMap;
      document.getElementById('resetButton').onclick = resetView;
    }

    function updateMap() {
      showSpinner(true);
      lines.forEach(l => map.removeLayer(l));
      markers.forEach(m => map.removeLayer(m));
      lines = []; markers = [];

      const wf = document.getElementById('warehouseTypeFilter').value;
      const sf = document.getElementById('supervisorFilter').value;
      const rf = document.getElementById('regionFilter').value;

      const filtered = allData.filter(d =>
        (wf === 'all' || d['Warehouse Type'] === wf) &&
        (sf === 'all' || d['Supervisor'] === sf) &&
        (rf === 'all' || d['Regional Destination'] === rf)
      );

      filtered.forEach(drawRoute);

      if (rf !== 'all' && regionBounds[rf]) {
        map.fitBounds(regionBounds[rf]);
      } else {
        map.setView([12.8797, 121.7740], 6);
      }

      showSpinner(false);
    }

    function drawRoute(d) {
      const oLat = +d['Origin Lat'], oLng = +d['Origin Long'];
      const dLat = +d['Destination Lat'], dLng = +d['Destination Long'];
      if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) return;

      const origin = [oLat, oLng], dest = [dLat, dLng];
      const tooltip = `
        Route Type: ${d['Route Type']}<br>
        From: ${d['Origin Name']}<br>
        To: ${d['Destination Name']}<br>
        Location: ${d['Destination Location']}<br>
        Supervisor: ${d['Supervisor']}
      `;

      const line = L.polyline([origin, dest], {
        color: getColor(d['Route Type']),
        weight: 2,
        dashArray: getDash(d['Route Type'])
      }).addTo(map).bindTooltip(tooltip);
      lines.push(line);

      const originMarker = (Math.abs(oLat - 10.380134047948756) < 1e-4 && Math.abs(oLng - 123.99598647262346) < 1e-4)
        ? L.marker(origin, { icon: cebuIcon }).bindTooltip('GTCosmetics Manufacturing Inc.<br>Main Plant<br>Tayud, Liloan, Cebu')
        : L.circleMarker(origin, { radius: getSize(d['Route Type']), color: getColor(d['Route Type']) }).bindTooltip(tooltip);

      const destMarker = L.circleMarker(dest, {
        radius: getSize(d['Route Type']),
        color: getColor(d['Route Type'])
      }).bindTooltip(tooltip);

      originMarker.addTo(map);
      destMarker.addTo(map);
      markers.push(originMarker, destMarker);
    }

    function getColor(type) {
      if (type.startsWith('Cebu Main')) return 'black';
      if (type.includes('Sub-warehouse')) return 'blue';
      if (type.includes('Satellite')) return 'green';
      return 'gray';
    }

    function getDash(type) {
      return type.includes('to Bin') ? '5,5' : null;
    }

    function getSize(type) {
      return {
        'Cebu Main': 6,
        'Cebu Main to Sub-warehouse': 6,
        'Cebu Main to Bin': 5,
        'Sub-warehouse to Satellite Warehouse': 5,
        'Sub-warehouse to Bin': 4,
        'Satellite Warehouse to Bin': 3
      }[type] || 4;
    }

    function resetView() {
      document.getElementById('warehouseTypeFilter').value = 'all';
      document.getElementById('supervisorFilter').value = 'all';
      document.getElementById('regionFilter').value = 'all';
      map.setView([12.8797, 121.7740], 6);
      updateMap();
    }

    function addLegend() {
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <span style="background:black"></span> Cebu Main<br>
          <span style="background:blue"></span> Sub-warehouse<br>
          <span style="background:green"></span> Satellite Warehouse
        `;
        return div;
      };
      legend.addTo(map);
    }
  </script>
</body>
</html>
