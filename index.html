<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warehouse Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 100%; }
    #filters { margin: 20px; font-family: Arial, sans-serif; }
    #resetButton { padding: 6px 12px; margin-left:10px; }
    .legend { background:white; padding:8px; font-size:12px; line-height:1.4; border-radius:4px; border:1px solid #ccc; }
    .legend span { display:inline-block; width:12px; height:12px; margin-right:4px; vertical-align:middle; }
    .tooltip-bold { font-weight: bold; }
  </style>
</head>
<body>
  <div id="filters">
    <label>Warehouse Type: <select id="warehouseTypeFilter"></select></label>
    <label>Supervisor: <select id="supervisorFilter"></select></label>
    <label>Region: <select id="regionFilter"></select></label>
    <button id="resetButton">Reset View</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?gid=542207452&single=true&output=csv';
    const cebuIcon = L.icon({
      iconUrl: 'https://www.gtcosmetics.com.ph/wp-content/uploads/2020/10/GT-Cosmetics.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const regionBounds = {
      "all": [[4.5,116],[20.5,127]], // Example bounds
      "Region I": [[15.6,119.5],[18.7,121.5]],
      // Add other regions as needed
    };

    const map = L.map('map').setView([10.3157,123.8854], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allData = [], lines = [], markers = [];

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: res => {
        allData = res.data.filter(r => r['Route ID']);
        setup();
      }
    });

    function setup() {
      populateFilters();
      updateMap();
      addLegend();
    }

    function populateFilters(){
      const w = new Set(), s = new Set(), r = new Set();
      allData.forEach(d => {
        w.add(d['Warehouse Type']);
        s.add(d['Supervisor']);
        r.add(d['Regional Destination']);
      });

      const wf = document.getElementById('warehouseTypeFilter'),
            sf = document.getElementById('supervisorFilter'),
            rf = document.getElementById('regionFilter');

      wf.innerHTML = '<option value="all">All</option>' + [...w].map(i => `<option>${i}</option>`).join('');
      sf.innerHTML = '<option value="all">All</option>' + [...s].map(i => `<option>${i}</option>`).join('');
      rf.innerHTML = '<option value="all">All</option>' + [...r].map(i => `<option>${i}</option>`).join('');

      wf.onchange = updateMap;
      sf.onchange = updateMap;
      rf.onchange = () => {
        const val = rf.value;
        if (regionBounds[val]) map.fitBounds(regionBounds[val]);
        updateMap();
      };

      document.getElementById('resetButton').onclick = () => {
        document.getElementById('warehouseTypeFilter').value = 'all';
        document.getElementById('supervisorFilter').value = 'all';
        document.getElementById('regionFilter').value = 'all';
        map.fitBounds(regionBounds['all']);
        updateMap();
      };
    }

    function updateMap(){
      lines.forEach(l => map.removeLayer(l)); lines = [];
      markers.forEach(m => map.removeLayer(m)); markers = [];

      const wf = document.getElementById('warehouseTypeFilter').value;
      const sf = document.getElementById('supervisorFilter').value;
      const rf = document.getElementById('regionFilter').value;

      const filt = allData.filter(d =>
        (wf === 'all' || d['Warehouse Type'] === wf) &&
        (sf === 'all' || d['Supervisor'] === sf) &&
        (rf === 'all' || d['Regional Destination'] === rf)
      );

      filt.forEach(draw);
    }

    function draw(d){
      const oLat = +d['Origin Lat'], oLng = +d['Origin Long'];
      const dLat = +d['Destination Lat'], dLng = +d['Destination Long'];
      if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) return;

      const o = [oLat, oLng], u = [dLat, dLng];
      const txt = `
        <span class="tooltip-bold">Route Type:</span> ${d['Route Type']}<br>
        <span class="tooltip-bold">From:</span> ${d['Origin Name']}<br>
        <span class="tooltip-bold">To:</span> ${d['Destination Name']}<br>
        <span class="tooltip-bold">Location:</span> ${d['Destination Location']}<br>
        <span class="tooltip-bold">Supervisor:</span> ${d['Supervisor']}
      `;

      const line = L.polyline([o, u], {
        color: getColor(d['Route Type']),
        weight: 1.5,
        dashArray: getDash(d['Route Type'])
      }).addTo(map).bindTooltip(txt);

      lines.push(line);

      // Show GT logo at Cebu Main location permanently
      const cebuMainCoords = [10.3802, 123.9961]; // Use your provided coordinates
      const om = Math.abs(o[0] - cebuMainCoords[0]) < 1e-4 && Math.abs(o[1] - cebuMainCoords[1]) < 1e-4
        ? L.marker(o, {icon: cebuIcon}).bindTooltip('GTCosmetics Manufacturing Inc.<br>Main Plant<br>Tayud, Liloan, Cebu').openTooltip()
        : L.circleMarker(o, {radius: getSize(d['Route Type']), color: getColor(d['Route Type'])}).bindTooltip(txt);

      const dm = L.circleMarker(u, {radius: getSize(d['Route Type']), color: getColor(d['Route Type'])}).bindTooltip(txt);
      map.addLayer(om); map.addLayer(dm);
      markers.push(om, dm);
    }

    function getColor(t) {
      if (t.startsWith('Cebu Main')) return 'black';
      if (t.includes('Satellite')) return 'green';
      if (t.includes('Sub-warehouse')) return 'blue';
      return 'gray';
    }

    function getDash(t) { return t.includes('to Bin') ? '5,5' : null; }
    function getSize(t) { return {'Cebu Main': 6, 'Cebu Main to Sub-warehouse': 6, 'Cebu Main to Bin': 5, 'Sub-warehouse to Satellite Warehouse': 5, 'Sub-warehouse to Bin': 4, 'Satellite Warehouse to Bin': 3}[t] || 4; }

    function addLegend(){
      const legendControl = L.control({position: 'bottomright'});
      legendControl.onAdd = function(){
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <span style="background:black"></span> Cebu Main<br>
          <span style="background:blue"></span> Sub-warehouse<br>
          <span style="background:green"></span> Satellite Warehouse
        `;
        return div;
      };
      legendControl.addTo(map);
    }
  </script>
</body>
</html>
