<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    #map { height: 600px; width: 100%; }
    #filters { margin: 20px; font-family: Arial, sans-serif; }
    .legend {
      background: white;
      padding: 10px;
      font-size: 12px;
      line-height: 1.5;
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 1000;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="filters">
    <label for="warehouseTypeFilter">Warehouse Type: </label>
    <select id="warehouseTypeFilter"></select>

    <label for="supervisorFilter">Supervisor: </label>
    <select id="supervisorFilter"></select>

    <label for="regionFilter">Region: </label>
    <select id="regionFilter"></select>

    <label for="provinceFilter">Province: </label>
    <select id="provinceFilter"></select>
  </div>
  <div id="map"></div>
  <div class="legend" id="mapLegend">
    <div><span style="background:black"></span> Cebu Main Routes</div>
    <div><span style="background:blue"></span> Sub-warehouse Routes</div>
    <div><span style="background:green"></span> Satellite Warehouse Routes</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?output=csv';
    let map = L.map('map').setView([10.3157, 123.8854], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    let allData = [];
    let lines = [];

    const regionBounds = {
      "Region I": [[15.6, 119.5], [18.7, 121.5]],
      "CAR": [[16.0, 120.5], [18.0, 122.0]],
      "Region II": [[16.2, 121.3], [18.5, 122.5]],
      "Region III": [[14.5, 119.5], [16.2, 121.5]],
      "NCR": [[14.3, 120.8], [14.8, 121.2]],
      "Region IV-A": [[13.4, 120.5], [15.0, 122.0]],
      "Region IV-B": [[11.8, 118.0], [13.8, 121.5]],
      "Region V": [[12.5, 123.2], [14.0, 124.5]],
      "Region VI": [[10.3, 121.0], [11.8, 123.0]],
      "Region VII": [[9.2, 122.2], [11.5, 124.0]],
      "Region VIII": [[10.5, 124.5], [12.5, 126.0]],
      "Region IX": [[6.0, 121.0], [8.5, 123.0]],
      "Region X": [[7.5, 123.5], [9.5, 125.0]],
      "Region XI": [[6.5, 125.0], [8.0, 126.5]],
      "Region XII": [[6.0, 124.0], [7.8, 126.0]],
      "Region XIII": [[8.5, 125.0], [10.5, 126.5]],
      "BARMM": [[5.5, 120.0], [7.8, 124.5]]
    };

    function fetchData() {
      Papa.parse(sheetUrl, {
        download: true,
        header: true,
        complete: function(results) {
          allData = results.data.filter(row => row['Route ID']);
          populateFilters();
          updateMap();
        }
      });
    }

    function populateFilters() {
      const warehouseTypeSet = new Set();
      const supervisorSet = new Set();
      const regionSet = new Set();
      const provinceMap = {};

      allData.forEach(row => {
        warehouseTypeSet.add(row['Warehouse Type']);
        supervisorSet.add(row['Supervisor']);
        regionSet.add(row['Regional Destination']);

        const region = row['Regional Destination'];
        const province = row['Provincial Destination'];
        if (region && province) {
          if (!provinceMap[region]) provinceMap[region] = new Set();
          provinceMap[region].add(province);
        }
      });

      const warehouseTypeFilter = document.getElementById('warehouseTypeFilter');
      const supervisorFilter = document.getElementById('supervisorFilter');
      const regionFilter = document.getElementById('regionFilter');
      const provinceFilter = document.getElementById('provinceFilter');

      warehouseTypeFilter.innerHTML = '<option value="all">All Warehouse Types</option>' +
        Array.from(warehouseTypeSet).map(type => `<option value="${type}">${type}</option>`).join('');

      supervisorFilter.innerHTML = '<option value="all">All Supervisors</option>' +
        Array.from(supervisorSet).map(name => `<option value="${name}">${name}</option>`).join('');

      regionFilter.innerHTML = '<option value="all">All Regions</option>' +
        Array.from(regionSet).map(region => `<option value="${region}">${region}</option>`).join('');

      regionFilter.addEventListener('change', () => {
        const selectedRegion = regionFilter.value;
        const provinces = provinceMap[selectedRegion] || new Set();
        provinceFilter.innerHTML = '<option value="all">All Provinces</option>' +
          Array.from(provinces).map(prov => `<option value="${prov}">${prov}</option>`).join('');
        updateMap();
      });

      warehouseTypeFilter.addEventListener('change', updateMap);
      supervisorFilter.addEventListener('change', updateMap);
      provinceFilter.addEventListener('change', updateMap);
    }

    function updateMap() {
      lines.forEach(line => map.removeLayer(line));
      lines = [];
      markerCluster.clearLayers();

      const selectedWarehouse = document.getElementById('warehouseTypeFilter').value;
      const selectedSupervisor = document.getElementById('supervisorFilter').value;
      const selectedRegion = document.getElementById('regionFilter').value;
      const selectedProvince = document.getElementById('provinceFilter').value;

      const filtered = allData.filter(row => {
        const matchesWarehouse = selectedWarehouse === 'all' || row['Warehouse Type'] === selectedWarehouse;
        const matchesSupervisor = selectedSupervisor === 'all' || row['Supervisor'] === selectedSupervisor;
        const matchesRegion = selectedRegion === 'all' || row['Regional Destination'] === selectedRegion;
        const matchesProvince = selectedProvince === 'all' || row['Provincial Destination'] === selectedProvince;
        return matchesWarehouse && matchesSupervisor && matchesRegion && matchesProvince;
      });

      filtered.forEach(row => drawRoute(row));

      if (selectedProvince !== 'all') {
        const provinceData = filtered.find(row => row['Provincial Destination'] === selectedProvince);
        if (provinceData) {
          const lat = parseFloat(provinceData['Destination Lat']);
          const lng = parseFloat(provinceData['Destination Long']);
          if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], 10);
            return;
          }
        }
      } else if (selectedRegion !== 'all' && regionBounds[selectedRegion]) {
        map.fitBounds(L.latLngBounds(regionBounds[selectedRegion]));
      } else {
        map.setView([10.3157, 123.8854], 6);
      }
    }

    function drawRoute(route) {
      const origin = [parseFloat(route['Origin Lat']), parseFloat(route['Origin Long'])];
      const dest = [parseFloat(route['Destination Lat']), parseFloat(route['Destination Long'])];
      const color = getRouteColor(route['Route Type']);
      const weight = 1.5;
      const dash = getRouteDash(route['Route Type']);
      const markerSize = getMarkerSize(route['Route Type']);

      const popupText = `<strong>${route['Route Type']}</strong><br>${route['Destination Name']} - ${route['Destination Location']}<br><em>${route['Supervisor']}</em>`;

      const line = L.polyline([origin, dest], {
        color: color,
        weight: weight,
        dashArray: dash
      }).bindTooltip(popupText).addTo(map);

      const originMarker = L.circleMarker(origin, { radius: markerSize, color: color })
        .bindTooltip("Origin: " + route['Origin Location']).addTo(markerCluster);

      const destMarker = L.circleMarker(dest, { radius: markerSize, color: color })
        .bindTooltip("Destination: " + route['Destination Location']).addTo(markerCluster);

      lines.push(line);
    }

    function getRouteColor(type) {
      if (type === 'Cebu Main') return 'black';
      if (type === 'Cebu Main to Sub-warehouse') return 'black';
      if (type === 'Cebu Main to Bin') return 'black';
      if (type === 'Sub-warehouse to Satellite Warehouse') return 'blue';
      if (type === 'Sub-warehouse to Bin') return 'blue';
      if (type === 'Satellite Warehouse to Bin') return 'green';
      return 'gray';
    }

    function getRouteDash(type) {
      if (type.includes('to Bin')) return '5,5';
      return null;
    }

    function getMarkerSize(type) {
      if (type === 'Cebu Main') return 6;
      if (type === 'Cebu Main to Sub-warehouse') return 6;
      if (type === 'Cebu Main to Bin') return 5;
      if (type === 'Sub-warehouse to Satellite Warehouse') return 5;
      if (type === 'Sub-warehouse to Bin') return 4;
      if (type === 'Satellite Warehouse to Bin') return 3;
      return 4;
    }

    fetchData();
  </script>
</body>
</html>
