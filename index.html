<!DOCTYPE html>
<html>
<head>
  <title>Warehouse Route Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .legend {
      background: white;
      padding: 10px;
      line-height: 1.5;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
      vertical-align: middle;
    }
    #filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    #searchBar {
      position: absolute;
      top: 10px;
      right: 20px;
      z-index: 1001;
      padding: 8px;
      font-size: 14px;
      width: 250px;
    }
    #autocomplete-list {
      position: absolute;
      top: 50px;
      right: 20px;
      width: 250px;
      max-height: 150px;
      overflow-y: auto;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 1001;
      font-family: Arial, sans-serif;
      font-size: 13px;
      list-style-type: none;
      padding-left: 0;
      margin: 0;
    }
    #autocomplete-list li {
      padding: 6px 8px;
      cursor: pointer;
    }
    #autocomplete-list li:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>

<div id="filters">
  <label>Warehouse Type:
    <select id="warehouseTypeFilter">
      <option value="all">All</option>
      <option value="Sub-warehouse">Sub-warehouse</option>
      <option value="Satellite Warehouse">Satellite Warehouse</option>
      <option value="Bin">Bin</option>
    </select>
  </label><br/>
  <label>Supervisor:
    <select id="supervisorFilter">
      <option value="all">All</option>
    </select>
  </label><br/>
  <label>Region:
    <select id="regionFilter">
      <option value="all">All</option>
    </select>
  </label><br/>
  <button id="resetButton">Reset</button>
</div>

<input type="text" id="searchBar" placeholder="Search Destination...">
<ul id="autocomplete-list"></ul>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
<script src="provinceBounds.js"></script>
<script>
  const map = L.map('map').setView([10.3157, 123.8854], 6);

  const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const markerCluster = L.markerClusterGroup();
  const routeLines = L.layerGroup();
  const legend = L.control({ position: 'bottomright' });

  let allData = [];
  let searchMarker = null;

  const warehouseTypeFilter = document.getElementById('warehouseTypeFilter');
  const supervisorFilter = document.getElementById('supervisorFilter');
  const regionFilter = document.getElementById('regionFilter');

  function getColor(route) {
    const colors = {
      Route1: '#1f77b4',
      Route2: '#ff7f0e',
      Route3: '#2ca02c',
      Route4: '#d62728',
      Route5: '#9467bd'
    };
    return colors[route] || '#000000';
  }

  function getBinColor(type) {
    return type === 'Bin' ? 'red' : '#3388ff';
  }

  function updateMap() {
    markerCluster.clearLayers();
    routeLines.clearLayers();

    const type = warehouseTypeFilter.value;
    const supervisor = supervisorFilter.value;
    const region = regionFilter.value;

    const filtered = allData.filter(row =>
      (type === 'all' || row['Warehouse Type'] === type) &&
      (supervisor === 'all' || row['Supervisor'] === supervisor) &&
      (region === 'all' || row['Region'] === region)
    );

    const destinations = {};

    filtered.forEach(row => {
      const origin = [parseFloat(row['Origin Lat']), parseFloat(row['Origin Long'])];
      const destination = [parseFloat(row['Destination Lat']), parseFloat(row['Destination Long'])];
      const route = row['Route'];
      const color = getColor(route);
      const typeColor = getBinColor(row['Warehouse Type']);

      const line = L.polyline([origin, destination], { color }).bindTooltip(
        `<b>Route:</b> ${route}<br><b>Type:</b> ${row['Warehouse Type']}<br><b>Destination:</b> ${row['Destination Name']}`,
        { permanent: false }
      );
      routeLines.addLayer(line);

      const destKey = row['Destination Name'];
      if (!destinations[destKey]) {
        const marker = L.circleMarker(destination, {
          radius: 8,
          fillColor: typeColor,
          color: '#000',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }).bindTooltip(
          `<b>${row['Destination Name']}</b><br>${row['Warehouse Type']}`,
          { permanent: false }
        );
        destinations[destKey] = marker;
        markerCluster.addLayer(marker);
      }
    });

    map.addLayer(markerCluster);
    map.addLayer(routeLines);
  }

  function loadCSV() {
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vRXiEjfsQZTx1OXgXvHfVTxq9PRebMHbGRcuKTVA2KyUghvdDIrDdPI9ZlsWgYJHcsawNaUYb7PvfrI/pub?gid=1510668684&single=true&output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data.filter(row => row['Origin Lat'] && row['Destination Lat']);
        populateFilters();
        updateMap();
      }
    });
  }

  function populateFilters() {
    const supervisors = new Set();
    const regions = new Set();
    allData.forEach(row => {
      if (row['Supervisor']) supervisors.add(row['Supervisor']);
      if (row['Region']) regions.add(row['Region']);
    });

    supervisors.forEach(s => {
      const opt = document.createElement('option');
      opt.value = opt.text = s;
      supervisorFilter.appendChild(opt);
    });

    regions.forEach(r => {
      const opt = document.createElement('option');
      opt.value = opt.text = r;
      regionFilter.appendChild(opt);
    });
  }

  warehouseTypeFilter.addEventListener('change', updateMap);
  supervisorFilter.addEventListener('change', updateMap);
  regionFilter.addEventListener('change', () => {
    const region = regionFilter.value;
    if (region !== 'all' && provinceBounds[region]) {
      map.fitBounds(provinceBounds[region]);
    }
    updateMap();
  });

  document.getElementById('resetButton').addEventListener('click', () => {
    warehouseTypeFilter.value = 'all';
    supervisorFilter.value = 'all';
    regionFilter.value = 'all';
    if (searchMarker) {
      map.removeLayer(searchMarker);
      searchMarker = null;
    }
    updateMap();
  });

  // GT logo at Cebu Main
  const gtIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/8/89/Logo_GT.png',
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    popupAnchor: [0, -20]
  });
  L.marker([10.3157, 123.8854], { icon: gtIcon }).addTo(map).bindPopup("<b>Cebu Main</b>");

  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `<b>Route Colors</b><br>
      <span style="background:#1f77b4"></span> Route1<br>
      <span style="background:#ff7f0e"></span> Route2<br>
      <span style="background:#2ca02c"></span> Route3<br>
      <span style="background:#d62728"></span> Route4<br>
      <span style="background:#9467bd"></span> Route5<br>
      <span style="background:red"></span> Bin`;
    return div;
  };
  legend.addTo(map);

  // Search bar functionality
  let matches = [];

  document.getElementById('searchBar').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    matches = allData.filter(item => item['Destination Name'].toLowerCase().includes(query));
    updateAutocompleteList(query);
  });

  function updateAutocompleteList(query) {
    const list = document.getElementById('autocomplete-list');
    list.innerHTML = '';
    matches.forEach(match => {
      const li = document.createElement('li');
      li.textContent = match['Destination Name'];
      li.addEventListener('click', () => handleSelectDestination(match));
      list.appendChild(li);
    });
  }

  function handleSelectDestination(match) {
    if (searchMarker) {
      map.removeLayer(searchMarker);
      searchMarker = null;
    }
    const coords = [parseFloat(match['Destination Lat']), parseFloat(match['Destination Long'])];
    map.setView(coords, 12);
    searchMarker = L.marker(coords).addTo(map)
      .bindPopup(`<b>${match['Destination Name']}</b>`)
      .openPopup();
  }

  loadCSV();
</script>

</body>
</html>
