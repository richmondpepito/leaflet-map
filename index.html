<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Warehouse Routes Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <style>
    #map { height: 90vh; width: 100%; }
    .legend { background: white; padding: 8px; font-size: 13px; line-height: 1.4; border-radius: 4px; border: 1px solid #ccc; }
    .legend span { display: inline-block; width: 12px; height: 12px; margin-right: 6px; vertical-align: middle; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?gid=542207452&single=true&output=csv';
    const map = L.map('map').setView([10.3157, 123.8854], 6);
    const clusterGroup = L.markerClusterGroup();

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const cebuIcon = L.icon({
      iconUrl: 'https://www.gtcosmetics.com.ph/wp-content/uploads/2020/10/GT-Cosmetics.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const cebuMainLatLng = [10.3802, 123.9961];

    // Cebu Main Permanent Logo
    L.marker(cebuMainLatLng, { icon: cebuIcon })
      .addTo(map)
      .bindTooltip('<b>GTCosmetics Manufacturing Inc.</b><br>Main Plant<br>Tayud, Liloan, Cebu', {
        permanent: false,  // hover-only
        direction: 'top'
      });

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: (results) => {
        const data = results.data.filter(row => row['Route ID']);

        data.forEach(row => {
          const oLat = parseFloat(row['Origin Lat']);
          const oLng = parseFloat(row['Origin Long']);
          const dLat = parseFloat(row['Destination Lat']);
          const dLng = parseFloat(row['Destination Long']);

          if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) return;

          const origin = [oLat, oLng];
          const dest = [dLat, dLng];

          const tooltipHtml = `
<strong>Route Type:</strong> ${row['Route Type']}<br>
<strong>From:</strong> ${row['Origin Name']}<br>
<strong>To:</strong> ${row['Destination Name']}<br>
<strong>Location:</strong> ${row['Destination Location']}<br>
<strong>Supervisor:</strong> ${row['Supervisor']}
          `;

          // Draw line
          const polyline = L.polyline([origin, dest], {
            color: getColor(row['Route Type']),
            weight: 2,
            dashArray: row['Route Type'].includes('to Bin') ? '4,4' : null
          }).bindTooltip(tooltipHtml);
          polyline.addTo(map);

          // Marker for destination (clustered)
          const destMarker = L.circleMarker(dest, {
            radius: 5,
            color: getColor(row['Route Type']),
            fillOpacity: 1
          }).bindTooltip(tooltipHtml);
          clusterGroup.addLayer(destMarker);

          // Marker for origin if not Cebu Main (clustered)
          if (!(oLat === 10.3802 && oLng === 123.9961)) {
            const originMarker = L.circleMarker(origin, {
              radius: 5,
              color: getColor(row['Route Type']),
              fillOpacity: 1
            }).bindTooltip(tooltipHtml);
            clusterGroup.addLayer(originMarker);
          }
        });

        map.addLayer(clusterGroup);
        addLegend();
      }
    });

    function getColor(type) {
      if (type.includes('Satellite')) return 'green';
      if (type.includes('Sub-warehouse')) return 'blue';
      if (type.includes('Bin')) return 'orange';
      return 'black';
    }

    function addLegend() {
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <span style="background:black"></span> Cebu Main<br>
          <span style="background:blue"></span> Sub-warehouse<br>
          <span style="background:green"></span> Satellite Warehouse<br>
          <span style="background:orange"></span> Bin
        `;
        return div;
      };
      legend.addTo(map);
    }
  </script>
</body>
</html>
