<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Warehouse Route Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; }
    .legend { background: white; padding: 6px; font-size: 14px; }
    .legend i { width: 12px; height: 12px; float: left; margin-right: 8px; opacity: 0.8; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map('map').setView([10.3157, 123.8854], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    const allData = [];
    const routeCooldowns = new Map();

    const getDestColor = (type) => {
      if (type === "Bin") return "red";
      if (type === "Satellite Warehouse") return "blue";
      if (type === "Sub-warehouse") return "green";
      return "gray";
    };

    const getSize = (type) => {
      if (type === "Primary") return 8;
      if (type === "Secondary") return 5;
      return 4;
    };

    function draw(d) {
      const o = [parseFloat(d['Origin Lat']), parseFloat(d['Origin Lng'])];
      const u = [parseFloat(d['Dest Lat']), parseFloat(d['Dest Lng'])];

      const color = getDestColor(d['Warehouse Type']);
      const radius = getSize(d['Route Type']);
      const routeKey = `${d['Route ID']}-${d['Route Type']}`;

      const line = L.polyline([o, u], {
        color: "#888", weight: 2, opacity: 0.5
      }).addTo(map);

      const marker = L.circleMarker(u, {
        radius: radius,
        color: color,
        fillColor: color,
        fillOpacity: 1,
      }).addTo(map);

      marker.bindTooltip(
        `<b>${d['Dest Name']}</b><br>${d['Warehouse Type']}<br>${d['Route Type']}`,
        { permanent: false }
      );

      function animateRoute(from, to, warehouseType, routeType, routeKey) {
        const cooldownTime = 3000;
        const now = Date.now();

        if (routeCooldowns.has(routeKey) && now - routeCooldowns.get(routeKey) < cooldownTime) return;
        routeCooldowns.set(routeKey, now);

        const steps = 100;
        const delay = 15;
        const color = getDestColor(warehouseType);
        const radius = getSize(routeType);
        let currentStep = 0;

        const latStep = (to[0] - from[0]) / steps;
        const lngStep = (to[1] - from[1]) / steps;

        const interval = setInterval(() => {
          if (currentStep >= steps) {
            clearInterval(interval);
            return;
          }

          const newLat = from[0] + latStep * currentStep;
          const newLng = from[1] + lngStep * currentStep;

          const fadingMarker = L.circleMarker([newLat, newLng], {
            radius: radius,
            color: color,
            fillColor: color,
            fillOpacity: 1,
            opacity: 1
          }).addTo(map);

          // Fade and remove
          setTimeout(() => {
            let fadeStep = 1.0;
            const fadeInterval = setInterval(() => {
              fadeStep -= 0.1;
              if (fadeStep <= 0) {
                clearInterval(fadeInterval);
                map.removeLayer(fadingMarker);
              } else {
                fadingMarker.setStyle({ fillOpacity: fadeStep, opacity: fadeStep });
              }
            }, 50);
          }, 500);

          currentStep++;
        }, delay);
      }

      line.on('mouseover', () => animateRoute(o, u, d['Warehouse Type'], d['Route Type'], routeKey));
      line.on('click', () => animateRoute(o, u, d['Warehouse Type'], d['Route Type'], routeKey));
    }

    function loadData() {
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv';
      fetch(url)
        .then(res => res.text())
        .then(csv => {
          const [headerLine, ...lines] = csv.trim().split('\n');
          const headers = headerLine.split(',');

          for (const line of lines) {
            const cells = line.split(',');
            const row = {};
            headers.forEach((h, i) => row[h.trim()] = cells[i]?.trim());
            allData.push(row);
          }

          allData.forEach(draw);
        });
    }

    loadData();
  </script>
</body>
</html>
