<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warehouse Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 100%; }
    #filters { margin: 20px; font-family: Arial, sans-serif; }
    #resetButton { padding: 6px 12px; margin-left: 10px; }
    .legend {
      background: white; padding: 8px; font-size: 12px; line-height: 1.4;
      border-radius: 4px; border: 1px solid #ccc;
    }
    .legend span {
      display: inline-block; width: 12px; height: 12px;
      margin-right: 4px; vertical-align: middle;
    }
    #loadingSpinner {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.8); padding: 20px 40px;
      border-radius: 8px; font-size: 16px; display: none; z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div id="filters">
  <label>Warehouse Type: <select id="warehouseTypeFilter"></select></label>
  <label>Supervisor: <select id="supervisorFilter"></select></label>
  <label>Region: <select id="regionFilter"></select></label>
  <label>Province: <select id="provinceFilter"></select></label>
  <button id="resetButton">Reset View</button>
</div>

<div id="loadingSpinner">ðŸ”„ Loading routes... Please wait</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0YzBM0KMyrNOC9sZ0KiLDwlk4kgVmjSxpls4k_aD-Wg9fbK2WYHUTstuI6XDqWSvHuy3gXtIz3l6g/pub?gid=542207452&single=true&output=csv';

const cebuIcon = L.icon({
  iconUrl: 'https://www.gtcosmetics.com.ph/wp-content/uploads/2020/10/GT-Cosmetics.png',
  iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
});

const regionBounds = {
  "all": [[4.5,116],[20.5,127]],
  "Region I": [[15.6,119.5],[18.7,121.5]], "CAR": [[16,120.5],[18,122]], "Region II": [[16.2,121.3],[18.5,122.5]],
  "Region III": [[14.5,119.5],[16.2,121.5]], "NCR": [[14.3,120.8],[14.8,121.2]], "Region IV-A": [[13.4,120.5],[15,122]],
  "Region IV-B": [[11.8,118],[13.8,121.5]], "Region V": [[12.5,123.2],[14,124.5]], "Region VI": [[10.3,121],[11.8,123]],
  "Region VII": [[9.2,122.2],[11.5,124]], "Region VIII": [[10.5,124.5],[12.5,126]], "Region IX": [[6,121],[8.5,123]],
  "Region X": [[7.5,123.5],[9.5,125]], "Region XI": [[6.5,125],[8,126.5]], "Region XII": [[6,124],[7.8,126]],
  "Region XIII": [[8.5,125],[10.5,126.5]], "BARMM": [[5.5,120],[7.8,124.5]]
};

const map = L.map('map').setView([10.3157, 123.8854], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let allData = [], lines = [], markers = [];
let currentRegion = 'all', currentProvince = 'all';

const spinner = document.getElementById('loadingSpinner');
spinner.style.display = 'block';

Papa.parse(sheetUrl, {
  download: true,
  header: true,
  complete: res => {
    allData = res.data.filter(r => r['Route ID']);
    spinner.style.display = 'none';
    setup();
  }
});

function setup() {
  populateFilters();
  updateMap();
  addLegend();
}

function populateFilters(){
  const warehouseTypes = new Set();
  const supervisors = new Set();
  const regions = new Set();
  const provinceMap = {};

  allData.forEach(d => {
    warehouseTypes.add(d['Warehouse Type']);
    supervisors.add(d['Supervisor']);
    regions.add(d['Regional Destination']);

    const region = d['Regional Destination'];
    const province = d['Provincial Destination'];
    if (region && province) {
      if (!provinceMap[region]) provinceMap[region] = new Set();
      provinceMap[region].add(province);
    }
  });

  const warehouseTypeFilter = document.getElementById('warehouseTypeFilter');
  const supervisorFilter = document.getElementById('supervisorFilter');
  const regionFilter = document.getElementById('regionFilter');
  const provinceFilter = document.getElementById('provinceFilter');

  warehouseTypeFilter.innerHTML = '<option value="all">All</option>' + [...warehouseTypes].map(i => `<option>${i}</option>`).join('');
  supervisorFilter.innerHTML = '<option value="all">All</option>' + [...supervisors].map(i => `<option>${i}</option>`).join('');
  regionFilter.innerHTML = '<option value="all">All</option>' + [...regions].map(i => `<option>${i}</option>`).join('');

  regionFilter.onchange = () => {
    currentRegion = regionFilter.value;
    const provinces = provinceMap[currentRegion] || new Set();
    provinceFilter.innerHTML = '<option value="all">All</option>' + [...provinces].map(p => `<option>${p}</option>`).join('');
    zoomToRegion(currentRegion);
    updateMap();
  };

  provinceFilter.onchange = () => {
    currentProvince = provinceFilter.value;
    zoomToProvince(currentProvince);
    updateMap();
  };

  warehouseTypeFilter.onchange = updateMap;
  supervisorFilter.onchange = updateMap;
  document.getElementById('resetButton').onclick = resetView;
}

function updateMap(){
  lines.forEach(l => map.removeLayer(l));
  markers.forEach(m => map.removeLayer(m));
  lines = [];
  markers = [];

  const wf = document.getElementById('warehouseTypeFilter').value;
  const sf = document.getElementById('supervisorFilter').value;

  const filtered = allData.filter(d =>
    (wf === 'all' || d['Warehouse Type'] === wf) &&
    (sf === 'all' || d['Supervisor'] === sf) &&
    (currentRegion === 'all' || d['Regional Destination'] === currentRegion) &&
    (currentProvince === 'all' || d['Provincial Destination'] === currentProvince)
  );

  filtered.forEach(draw);
}

function draw(d){
  const oLat = +d['Origin Lat'], oLng = +d['Origin Long'];
  const dLat = +d['Destination Lat'], dLng = +d['Destination Long'];
  if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) return;

  const origin = [oLat, oLng];
  const dest = [dLat, dLng];

  const tooltip = `Route Type: ${d['Route Type']}
From: ${d['Origin Name']}
To: ${d['Destination Name']}
Location: ${d['Destination Location']}
Supervisor: ${d['Supervisor']}`;

  const line = L.polyline([origin, dest], {
    color: getColor(d['Route Type']),
    weight: 1.5,
    dashArray: getDash(d['Route Type'])
  }).bindTooltip(tooltip).addTo(map);

  lines.push(line);

  let om;
  if (Math.abs(origin[0] - 10.380134) < 1e-4 && Math.abs(origin[1] - 123.995986) < 1e-4) {
    om = L.marker(origin, { icon: cebuIcon }).bindTooltip('GTCosmetics Manufacturing Inc.<br>Main Plant<br>Tayud, Liloan, Cebu');
  } else {
    om = L.circleMarker(origin, { radius: getSize(d['Route Type']), color: getColor(d['Route Type']) }).bindTooltip(tooltip);
  }

  const dm = L.circleMarker(dest, { radius: getSize(d['Route Type']), color: getColor(d['Route Type']) }).bindTooltip(tooltip);

  markers.push(om, dm);
  map.addLayer(om);
  map.addLayer(dm);
}

function getColor(t){
  if (t.startsWith('Cebu Main')) return 'black';
  if (t.includes('Satellite')) return 'green';
  if (t.includes('Sub-warehouse')) return 'blue';
  return 'gray';
}

function getDash(t){ return t.includes('to Bin') ? '5,5' : null; }

function getSize(t){
  return {
    'Cebu Main': 6,
    'Cebu Main to Sub-warehouse': 6,
    'Cebu Main to Bin': 5,
    'Sub-warehouse to Satellite Warehouse': 5,
    'Sub-warehouse to Bin': 4,
    'Satellite Warehouse to Bin': 3
  }[t] || 4;
}

function resetView(){
  currentRegion = 'all';
  currentProvince = 'all';
  document.getElementById('warehouseTypeFilter').value = 'all';
  document.getElementById('supervisorFilter').value = 'all';
  document.getElementById('regionFilter').value = 'all';
  document.getElementById('provinceFilter').innerHTML = '<option value="all">All</option>';
  map.fitBounds(regionBounds['all']);
  updateMap();
}

function zoomToRegion(region){
  if (regionBounds[region]) map.fitBounds(regionBounds[region]);
}

function zoomToProvince(province){
  const provData = allData.filter(d => d['Provincial Destination'] === province);
  if (provData.length > 0){
    const bounds = L.latLngBounds(provData.flatMap(d => [
      [+d['Origin Lat'], +d['Origin Long']],
      [+d['Destination Lat'], +d['Destination Long']]
    ]));
    if (bounds.isValid()) map.fitBounds(bounds);
  }
}

function addLegend(){
  const legend = L.control({position:'bottomright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <span style="background:black"></span> Cebu Main<br>
      <span style="background:blue"></span> Sub-warehouse<br>
      <span style="background:green"></span> Satellite Warehouse
    `;
    return div;
  };
  legend.addTo(map);
}
</script>
</body>
</html>
